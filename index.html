<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQM1ãƒ»2 PSç‰ˆ é…åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã€å®¶ç³»å›³è¡¨ç¤ºã€‘</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --border: #334155; --parent-color: #38bdf8; --child-color: #f8fafc; --start-color: #fb7185; --family-list-color: #f472b6; }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.6; }
        .wrapper { max-width: 1000px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--accent); }
        select { width: 100%; padding: 12px; border-radius: 8px; background: #0f172a; color: white; border: 1px solid var(--border); font-size: 16px; margin-bottom: 15px; }
        button { width: 100%; padding: 15px; background: var(--accent); color: #0f172a; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #7dd3fc; }
        #output { background: #000; color: #10b981; padding: 20px; border-radius: 8px; font-family: 'Consolas', monospace; overflow-x: auto; border: 1px solid var(--accent); line-height: 1.4; font-size: 13px; }
        .error { color: #f87171; font-weight: bold; }

        /* å®¶ç³»å›³è¡¨ç¤ºã®ãŸã‚ã®CSS */
        .genealogy-tree ul { list-style: none; margin: 0; padding-left: 20px; position: relative; }
        .genealogy-tree ul ul { padding-left: 30px; }
        .genealogy-tree li { position: relative; margin-bottom: 10px; padding-left: 20px; }
        .genealogy-tree li::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            border-left: 1px dashed var(--border);
            width: 1px;
            height: 100%;
        }
        .genealogy-tree li:last-child::before { height: 16px; /* æœ€å¾Œã®è¦ç´ ã¯ä¸‹ã¾ã§ç·šãŒã„ã‚‰ãªã„ */ }
        .genealogy-tree li::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            border-top: 1px dashed var(--border);
            width: 20px;
            height: 1px;
        }
        .genealogy-tree > ul > li::before { /* æœ€ä¸Šä½ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«ã¯å·¦ã®ç·šã¯ä¸è¦ */ display: none; }
        .genealogy-tree > ul > li::after { /* æœ€ä¸Šä½ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã«ã¯å·¦ã®ç·šã¯ä¸è¦ */ display: none; }
        
        .monster-node {
            display: inline-block;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 10px;
            font-weight: bold;
            line-height: 1.2;
            color: var(--child-color);
            white-space: nowrap; /* ãƒãƒ¼ãƒ‰å†…ã§æ”¹è¡Œã—ãªã„ */
        }
        .monster-node.target { background: var(--parent-color); color: var(--bg); border-color: var(--accent); }
        .monster-node.start { background: var(--start-color); color: var(--bg); border-color: var(--start-color); }
        .monster-node.family-type { color: var(--family-list-color); background: #2f3e4e; border-color: #556a81; }
        .alt-recipe-info { font-size: 0.8em; color: #6b7280; margin-left: 8px; display: inline-block; }
        .summary-section { margin-top: 30px; padding-top: 15px; border-top: 1px solid var(--border); }
        .summary-section h3 { color: var(--accent); margin-bottom: 10px; }
        .family-list-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); }
        .family-list-section h3 { color: var(--family-list-color); margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="wrapper">
        <header><h1>ğŸ‘¾ DQM1ãƒ»2 PSç‰ˆ é…åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1></header>
        <div class="card">
            <label>1. ç›®æ¨™ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ç³»çµ±</label>
            <select id="familySelect" onchange="updateTargetList()"><option value="">-- èª­ã¿è¾¼ã¿ä¸­ --</option></select>
            <label>2. ç›®æ¨™ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</label>
            <select id="targetSelect" disabled onchange="updateStartList()"><option value="">-- ç³»çµ±ã‚’é¸ã‚“ã§ãã ã•ã„ --</option></select>
            <label>3. æ‰‹æŒã¡ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‹ã‚‰é–‹å§‹ (é–¢é€£ç¨®ã®ã¿)</label>
            <select id="startSelect" disabled><option value="">-- æœ€åˆã‹ã‚‰è¨ˆç®— --</option></select>
            <button onclick="generateTree()">å®Œå…¨ãƒ«ãƒ¼ãƒˆè§£æå®Ÿè¡Œ</button>
        </div>
        <div id="resultCard" class="card" style="display:none;"><div id="output"></div></div>
    </div>

<script>
let monsterFamilies = {};
let fusionRecipes = {};

async function loadData() {
    try {
        const resFam = await fetch('family_list.json');
        const resFus = await fetch('fusion_list.json');
        monsterFamilies = await resFam.json();
        fusionRecipes = await resFus.json();
        
        const fSel = document.getElementById('familySelect');
        fSel.innerHTML = '<option value="">-- ç³»çµ±ã‚’é¸æŠ --</option>';
        Object.keys(monsterFamilies).sort().forEach(f => fSel.add(new Option(f, f))); // ç³»çµ±åã‚’ã‚½ãƒ¼ãƒˆ
    } catch (e) {
        alert("JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GitHubã®ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" + e.message);
        console.error("JSONãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", e);
    }
}

function updateTargetList() {
    const tSel = document.getElementById('targetSelect');
    const family = document.getElementById('familySelect').value;
    tSel.innerHTML = '<option value="">-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠ --</option>';
    if (family) {
        monsterFamilies[family].sort().forEach(m => tSel.add(new Option(m, m))); // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åã‚’ã‚½ãƒ¼ãƒˆ
        tSel.disabled = false;
    } else {
        tSel.disabled = true;
    }
    updateStartList();
}

function updateStartList() {
    const sSel = document.getElementById('startSelect');
    const target = document.getElementById('targetSelect').value;
    sSel.innerHTML = '<option value="">-- æœ€åˆã‹ã‚‰è¨ˆç®— --</option>';
    if (!target) { sSel.disabled = true; return; }

    const related = new Set();
    const q = [target];
    const visited = new Set();
    
    while(q.length > 0) {
        const current = q.shift();
        if (visited.has(current)) continue;
        visited.add(current);

        const routes = fusionRecipes.recipes[current];
        if (!routes) continue; // ç‰¹æ®Šé…åˆã‚„ç³»çµ±é…åˆã§ç›´æ¥ä½œã‚Œãªã„æœ€çµ‚ç´ æ

        routes.forEach(route => {
            route.forEach(p => {
                // pãŒç³»çµ±åã®å ´åˆã€ãã®ç³»çµ±ã«å±ã™ã‚‹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¯è¿½åŠ ã—ãªã„ï¼ˆé¸æŠè‚¢ãŒçˆ†ç™ºã™ã‚‹ãŸã‚ï¼‰
                if (!Object.keys(monsterFamilies).includes(p)) { 
                    if (!related.has(p)) {
                        related.add(p);
                        q.push(p); // æ¬¡ã®æ¢ç´¢å¯¾è±¡ã«è¿½åŠ 
                    }
                }
            });
        });
    }
    Array.from(related).sort().forEach(m => sSel.add(new Option(m, m)));
    sSel.disabled = false;
}


function generateTree() {
    const target = document.getElementById('targetSelect').value;
    const start = document.getElementById('startSelect').value;
    const output = document.getElementById('output');
    document.getElementById('resultCard').style.display = 'block';

    if (!target) {
        output.innerHTML = '<span class="error">ç›®æ¨™ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</span>';
        return;
    }

    // ç³»çµ±åãŒç›´æ¥é¸ã°ã‚ŒãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    if (Object.keys(monsterFamilies).includes(target)) {
        output.innerHTML = `<span class="error">ã€Œ${target}ã€ã¯ç³»çµ±åã§ã™ã€‚å€‹åˆ¥ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</span>`;
        return;
    }

    let summary = {}; // æœ€çµ‚ç´ æã®é›†è¨ˆ
    let activeFamilies = new Set(); // æœ€çµ‚ç´ æãŒå±ã™ã‚‹ç³»çµ±

    // buildTreeé–¢æ•°å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•° (ãƒã‚¹ãƒˆã—ã¦ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å…±æœ‰)
    function build(name, isTarget = false) {
        let nodeClass = 'monster-node';
        if (isTarget) nodeClass += ' target';
        if (name === start && start !== "") nodeClass += ' start';
        
        let isFamilyType = Object.keys(monsterFamilies).includes(name);
        if (isFamilyType) nodeClass += ' family-type';

        if ((name === start && start !== "") || !fusionRecipes.recipes[name] || isFamilyType) {
            // æ‰‹æŒã¡ã€æœ€çµ‚ç´ æï¼ˆãƒ¬ã‚·ãƒ”ãªã—ï¼‰ã€ç³»çµ±åã®å ´åˆã¯ã“ã‚Œä»¥ä¸Šæ˜ã‚Šä¸‹ã’ãªã„
            if (!isFamilyType && !(name === start && start !== "")) { // ç³»çµ±åã§ãªãã€ã‹ã¤æ‰‹æŒã¡ã§ãªã„ãªã‚‰é›†è¨ˆ
                summary[name] = (summary[name] || 0) + 1;
                // ã©ã®ç³»çµ±ã«å±ã™ã‚‹ã‹ã‚’åˆ¤å®šã—ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç³»çµ±ã«è¿½åŠ 
                for(let f in monsterFamilies) {
                    if (monsterFamilies[f].includes(name)) {
                        activeFamilies.add(f);
                        break;
                    }
                }
            } else if (isFamilyType) { // ç³»çµ±åã ã£ãŸå ´åˆã‚‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç³»çµ±ã«è¿½åŠ 
                 activeFamilies.add(name);
            }
            return `<li><span class="${nodeClass}">${name}</span></li>\n`;
        }

        const routes = fusionRecipes.recipes[name];
        // è¤‡æ•°ãƒ«ãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€ã“ã“ã§ã¯æœ€åˆã®ãƒ«ãƒ¼ãƒˆã‚’æ¡ç”¨
        const [p1, p2] = routes[0]; 
        
        let altRecipeInfo = routes.length > 1 ? `<span class="alt-recipe-info">(ä»–${routes.length - 1}ç¨®ã®ãƒ¬ã‚·ãƒ”ã‚ã‚Š)</span>` : '';

        return `<li><span class="${nodeClass}">${name}</span>${altRecipeInfo}\n<ul>\n` +
               build(p1) +
               build(p2) +
               `</ul>\n</li>\n`;
    }

    let treeHTML = `<div class="genealogy-tree"><ul>\n` + build(target, true) + `</ul></div>\n`;

    let summaryHTML = "";
    if (Object.keys(summary).length > 0) {
        summaryHTML = `<div class="summary-section"><h3><b style="color:#fbbf24">ã€æœ€çµ‚å¿…è¦ç´ æã€‘</b></h3><ul>\n` + 
                      Object.entries(summary).map(([m, c]) => `<li>${m} Ã— ${c}</li>`).join("\n") + 
                      `</ul></div>\n`;
    }
    
    let familyListHTML = "";
    if (activeFamilies.size > 0) {
        familyListHTML = `<div class="family-list-section"><h3><b style="color:#f472b6">ã€å‡ºç¾ã—ãŸç³»çµ±ã®å…¨ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã€‘</b></h3>\n`;
        Array.from(activeFamilies).sort().forEach(f => {
            if (monsterFamilies[f]) { // ç³»çµ±åãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
                familyListHTML += `<p><b>${f}:</b> ${monsterFamilies[f].join(", ")}</p>\n`;
            } else {
                // ã€Œãƒ‰ãƒ©ã‚´ãƒ³ç³»ã€ã®ã‚ˆã†ãªæŠ½è±¡çš„ãªç³»çµ±åãŒæœ€çµ‚ç´ æã«ãªã£ãŸå ´åˆã€ãã®ç³»çµ±ã®å…¨ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                familyListHTML += `<p><b>${f}:</b> ${Object.keys(monsterFamilies).includes(f) ? monsterFamilies[f].join(", ") : 'ä¸æ˜ãªç³»çµ±'}</p>\n`;
            }
        });
        familyListHTML += `</div>\n`;
    }

    output.innerHTML = treeHTML + summaryHTML + familyListHTML;
}

loadData();
</script>
</body>
</html>
