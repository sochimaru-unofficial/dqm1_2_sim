<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQM1ãƒ»2 PSç‰ˆ é…åˆãƒŠãƒ“ã€åˆ†å²ãƒ„ãƒªãƒ¼ç‰ˆã€‘</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --accent: #38bdf8;
            --border: #475569;
            --target-bg: #38bdf8;
            --start-bg: #fb7185;
            --family-text: #f472b6;
        }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .wrapper { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--accent); }
        select { width: 100%; padding: 10px; border-radius: 6px; background: #0f172a; color: white; border: 1px solid var(--border); margin-bottom: 15px; }
        button { width: 100%; padding: 15px; background: var(--accent); color: #0f172a; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* --- å®¶ç³»å›³ï¼ˆæ¨ªæ–¹å‘åˆ†å²ï¼‰ --- */
        .tree-container { overflow-x: auto; padding: 20px; background: #000; border-radius: 8px; border: 1px solid var(--accent); }
        .tree, .tree ul, .tree li { position: relative; list-style: none; margin: 0; padding: 0; }
        .tree ul { display: flex; flex-direction: column; justify-content: center; padding-left: 40px; } /* è¦ªï¼ˆå³å´ï¼‰ã¸ã®ä½™ç™½ */
        .tree li { display: flex; align-items: center; position: relative; padding: 10px 0; }

        /* åˆ†å²ç·šã®æç”» */
        .tree li::before {
            content: ""; position: absolute; left: 0; top: 50%;
            border-top: 2px solid var(--border); width: 20px;
        }
        /* ç¸¦ã®ã¤ãªãç·š */
        .tree li::after {
            content: ""; position: absolute; left: 0; 
            border-left: 2px solid var(--border); height: 100%; width: 2px;
        }
        .tree li:first-child::after { height: 50%; top: 50%; }
        .tree li:last-child::after { height: 50%; bottom: 50%; }
        .tree li:only-child::after { display: none; }

        /* å­ä¾›ã‹ã‚‰å‡ºã‚‹å³ã¸ã®çŸ­ã„ç·š */
        .monster-wrapper { position: relative; display: flex; align-items: center; }
        .has-children > .monster-wrapper::after {
            content: ""; position: absolute; right: -20px; top: 50%;
            border-top: 2px solid var(--border); width: 20px;
        }

        /* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒãƒƒãƒ— */
        .node {
            display: inline-block; padding: 6px 12px; border-radius: 4px;
            background: var(--card); border: 1px solid var(--border);
            font-weight: bold; cursor: pointer; white-space: nowrap; z-index: 1;
        }
        .node:hover { border-color: var(--accent); }
        .node.target { background: var(--target-bg); color: #000; }
        .node.start { background: var(--start-bg); color: #000; }
        .node.family { color: var(--family-text); cursor: default; }

        .switcher { margin-left: 5px; display: flex; gap: 2px; }
        .r-btn { font-size: 9px; padding: 1px 4px; background: #334155; border: 1px solid var(--border); color: #fff; cursor: pointer; }
        .r-btn.active { background: var(--accent); color: #000; }
    </style>
</head>
<body>
<div class="wrapper">
    <header><h1>ğŸ‘¾ DQM1ãƒ»2 PSç‰ˆ é…åˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1></header>
    <div class="card">
        <label>ç³»çµ±</label><select id="familySelect" onchange="updateTargetList()"></select>
        <label>ç›®æ¨™</label><select id="targetSelect" disabled onchange="resetAndStartList()"></select>
        <label>æ‰‹æŒã¡(ä»»æ„)</label><select id="startSelect" disabled></select>
        <button onclick="generateTree()">å®¶ç³»å›³ç”Ÿæˆ</button>
    </div>
    <div id="resultCard" class="card" style="display:none;"><div class="tree-container"><div id="output" class="tree"></div></div></div>
</div>

<script>
let monsterFamilies = {};
let fusionRecipes = {};
let selectedRecipeIndices = {};

async function loadData() {
    try {
        const resFam = await fetch('family_list.json');
        const resFus = await fetch('fusion_list.json');
        monsterFamilies = await resFam.json();
        fusionRecipes = await resFus.json();
        const fSel = document.getElementById('familySelect');
        fSel.innerHTML = '<option value="">-- ç³»çµ±ã‚’é¸æŠ --</option>';
        Object.keys(monsterFamilies).sort().forEach(f => fSel.add(new Option(f, f)));
    } catch (e) { alert("JSONèª­ã¿è¾¼ã¿å¤±æ•—"); }
}

function updateTargetList() {
    const tSel = document.getElementById('targetSelect');
    const f = document.getElementById('familySelect').value;
    tSel.innerHTML = '<option value="">-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠ --</option>';
    if (f) { monsterFamilies[f].sort().forEach(m => tSel.add(new Option(m, m))); tSel.disabled = false; }
    else tSel.disabled = true;
}

function resetAndStartList() { selectedRecipeIndices = {}; updateStartList(); }

function updateStartList() {
    const sSel = document.getElementById('startSelect');
    const target = document.getElementById('targetSelect').value;
    sSel.innerHTML = '<option value="">-- æœ€åˆã‹ã‚‰è¨ˆç®— --</option>';
    if (!target) { sSel.disabled = true; return; }
    const related = new Set();
    const q = [target];
    const visited = new Set();
    while(q.length > 0) {
        const cur = q.shift();
        if (visited.has(cur)) continue; visited.add(cur);
        const routes = fusionRecipes.recipes[cur];
        if (!routes) continue;
        routes.forEach(route => route.forEach(p => { if (!monsterFamilies[p]) { related.add(p); q.push(p); } }));
    }
    Array.from(related).sort().forEach(m => sSel.add(new Option(m, m)));
    sSel.disabled = false;
}

function jumpTo(monsterName) {
    if (monsterFamilies[monsterName]) return;
    for (let f in monsterFamilies) {
        if (monsterFamilies[f].includes(monsterName)) {
            document.getElementById('familySelect').value = f;
            updateTargetList();
            document.getElementById('targetSelect').value = monsterName;
            resetAndStartList();
            generateTree();
            return;
        }
    }
}

function switchR(event, name, idx) {
    event.stopPropagation();
    selectedRecipeIndices[name] = idx;
    generateTree();
}

function buildTreeHTML(name, isTarget = false) {
    const start = document.getElementById('startSelect').value;
    let nodeClass = 'node';
    if (isTarget) nodeClass += ' target';
    if (name === start && start !== "") nodeClass += ' start';
    const isFamily = !!monsterFamilies[name];
    if (isFamily) nodeClass += ' family';

    const routes = fusionRecipes.recipes[name];
    const canExpand = (name !== start || start === "") && routes && !isFamily;
    const itemClass = canExpand ? 'has-children' : '';

    let html = `<li class="${itemClass}"><div class="monster-wrapper">`;
    html += `<span class="${nodeClass}" onclick="jumpTo('${name}')">${name}</span>`;

    if (canExpand) {
        const idx = selectedRecipeIndices[name] || 0;
        if (routes.length > 1) {
            html += `<div class="switcher">`;
            routes.forEach((_, i) => {
                const active = i === idx ? 'active' : '';
                html += `<button class="r-btn ${active}" onclick="switchR(event,'${name}',${i})">R${i+1}</button>`;
            });
            html += `</div>`;
        }
        html += `</div><ul>`;
        html += buildTreeHTML(routes[idx][0]);
        html += buildTreeHTML(routes[idx][1]);
        html += `</ul>`;
    } else {
        html += `</div>`;
    }
    html += `</li>`;
    return html;
}

function generateTree() {
    const target = document.getElementById('targetSelect').value;
    if (!target) return;
    document.getElementById('resultCard').style.display = 'block';
    document.getElementById('output').innerHTML = `<ul>${buildTreeHTML(target, true)}</ul>`;
}

loadData();
</script>
</body>
</html>
