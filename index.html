<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQM1ãƒ»2 PSç‰ˆ é…åˆãƒŠãƒ“ã€ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½ã€‘</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #38bdf8; --border: #475569; --parent-color: #38bdf8; --child-color: #f8fafc; --start-color: #fb7185; --family-list-color: #f472b6; }
        body { font-family: 'Segoe UI', Meiryo, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.6; }
        .wrapper { max-width: 1100px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--accent); }
        select { width: 100%; padding: 12px; border-radius: 8px; background: #0f172a; color: white; border: 1px solid var(--border); font-size: 16px; margin-bottom: 15px; }
        button { width: 100%; padding: 15px; background: var(--accent); color: #0f172a; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #7dd3fc; }
        #output { background: #000; color: #10b981; padding: 20px; border-radius: 8px; font-family: 'Consolas', monospace; overflow-x: auto; border: 1px solid var(--accent); }

        /* å®¶ç³»å›³è¡¨ç¤º */
        .genealogy-tree ul { list-style: none; margin: 0; padding-left: 20px; position: relative; }
        .genealogy-tree li { position: relative; margin-bottom: 10px; padding-left: 20px; }
        .genealogy-tree li::before { content: ''; position: absolute; top: 0; left: 0; border-left: 1px dashed var(--border); width: 1px; height: 100%; }
        .genealogy-tree li:last-child::before { height: 16px; }
        .genealogy-tree li::after { content: ''; position: absolute; top: 15px; left: 0; border-top: 1px dashed var(--border); width: 20px; height: 1px; }
        .genealogy-tree > ul > li::before, .genealogy-tree > ul > li::after { display: none; }
        
        /* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰ */
        .monster-node { 
            display: inline-block; background: var(--card); border: 1px solid var(--border); border-radius: 6px; 
            padding: 5px 12px; font-weight: bold; color: var(--child-color); white-space: nowrap; 
            cursor: pointer; transition: 0.2s;
        }
        .monster-node:hover { background: #334155; border-color: var(--accent); }
        .monster-node.target { background: var(--parent-color); color: var(--bg); border-color: var(--accent); }
        .monster-node.start { background: var(--start-color); color: var(--bg); border-color: var(--start-color); }
        .monster-node.family-type { color: var(--family-list-color); background: #2f3e4e; cursor: default; } /* ç³»çµ±åã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯ */

        .recipe-switcher { display: inline-flex; gap: 4px; margin-left: 10px; vertical-align: middle; }
        .route-btn { background: #1e293b; color: #94a3b8; border: 1px solid var(--border); padding: 2px 6px; font-size: 10px; border-radius: 4px; cursor: pointer; }
        .route-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
        
        .summary-section { margin-top: 25px; color: #fbbf24; }
    </style>
</head>
<body>
    <div class="wrapper">
        <header><h1>ğŸ‘¾ DQM1ãƒ»2 PSç‰ˆ é…åˆãƒŠãƒ“ã€ã‚¯ãƒªãƒƒã‚¯æ·±æ˜ã‚Šç‰ˆã€‘</h1></header>
        <div class="card">
            <label>1. ç³»çµ±ã‚’é¸æŠ</label>
            <select id="familySelect" onchange="updateTargetList()"></select>
            <label>2. ç›®æ¨™ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠ</label>
            <select id="targetSelect" disabled onchange="resetAndStartList()"></select>
            <label>3. æ‰‹æŒã¡ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‹ã‚‰é–‹å§‹ (ä»»æ„)</label>
            <select id="startSelect" disabled></select>
            <button onclick="generateTree()">å®¶ç³»å›³ã‚’ç”Ÿæˆ</button>
        </div>
        <div id="resultCard" class="card" style="display:none;"><div id="output"></div></div>
    </div>

<script>
let monsterFamilies = {};
let fusionRecipes = {};
let selectedRecipeIndices = {}; 

async function loadData() {
    try {
        const resFam = await fetch('family_list.json');
        const resFus = await fetch('fusion_list.json');
        monsterFamilies = await resFam.json();
        fusionRecipes = await resFus.json();
        const fSel = document.getElementById('familySelect');
        fSel.innerHTML = '<option value="">-- ç³»çµ±ã‚’é¸æŠ --</option>';
        Object.keys(monsterFamilies).sort().forEach(f => fSel.add(new Option(f, f)));
    } catch (e) { alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
}

function updateTargetList() {
    const tSel = document.getElementById('targetSelect');
    const f = document.getElementById('familySelect').value;
    tSel.innerHTML = '<option value="">-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’é¸æŠ --</option>';
    if (f) { monsterFamilies[f].sort().forEach(m => tSel.add(new Option(m, m))); tSel.disabled = false; }
    else tSel.disabled = true;
}

function resetAndStartList() {
    selectedRecipeIndices = {}; 
    updateStartList();
}

function updateStartList() {
    const sSel = document.getElementById('startSelect');
    const target = document.getElementById('targetSelect').value;
    sSel.innerHTML = '<option value="">-- æœ€åˆã‹ã‚‰è¨ˆç®— --</option>';
    if (!target) { sSel.disabled = true; return; }
    const related = new Set();
    const q = [target];
    const visited = new Set();
    while(q.length > 0) {
        const cur = q.shift();
        if (visited.has(cur)) continue; visited.add(cur);
        const routes = fusionRecipes.recipes[cur];
        if (!routes) continue;
        routes.forEach(route => route.forEach(p => {
            if (!monsterFamilies[p]) { related.add(p); q.push(p); }
        }));
    }
    Array.from(related).sort().forEach(m => sSel.add(new Option(m, m)));
    sSel.disabled = false;
}

// å®¶ç³»å›³å†…ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
function jumpToMonster(monsterName) {
    if (monsterFamilies[monsterName]) return; // ç³»çµ±åãªã‚‰ä½•ã‚‚ã—ãªã„

    // ãã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒå±ã™ã‚‹ç³»çµ±ã‚’æ¢ã™
    for (let f in monsterFamilies) {
        if (monsterFamilies[f].includes(monsterName)) {
            document.getElementById('familySelect').value = f;
            updateTargetList();
            document.getElementById('targetSelect').value = monsterName;
            resetAndStartList();
            generateTree();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }
    }
}

function switchRecipe(event, monsterName, index) {
    event.stopPropagation(); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ã‚’é˜²æ­¢
    selectedRecipeIndices[monsterName] = index;
    generateTree();
}

function generateTree() {
    const target = document.getElementById('targetSelect').value;
    const start = document.getElementById('startSelect').value;
    const output = document.getElementById('output');
    if (!target) return;
    document.getElementById('resultCard').style.display = 'block';

    let summary = {};

    function build(name, isTarget = false) {
        let nodeClass = 'monster-node';
        if (isTarget) nodeClass += ' target';
        if (name === start && start !== "") nodeClass += ' start';
        
        const isFamily = !!monsterFamilies[name];
        if (isFamily) nodeClass += ' family-type';

        const onClickAttr = isFamily ? '' : `onclick="jumpToMonster('${name}')"`;

        // çµ‚ç«¯ï¼šæ‰‹æŒã¡ã€ãƒ¬ã‚·ãƒ”ãªã—ã€ã¾ãŸã¯ç³»çµ±å
        if ((name === start && start !== "") || !fusionRecipes.recipes[name] || isFamily) {
            if (!isFamily && name !== start) summary[name] = (summary[name] || 0) + 1;
            return `<li><span class="${nodeClass}" ${onClickAttr}>${name}</span></li>`;
        }

        const routes = fusionRecipes.recipes[name];
        const currentIndex = selectedRecipeIndices[name] || 0;
        const [p1, p2] = routes[currentIndex];

        let buttons = '';
        if (routes.length > 1) {
            buttons = `<span class="recipe-switcher">`;
            routes.forEach((_, i) => {
                const active = i === currentIndex ? 'active' : '';
                buttons += `<button class="route-btn ${active}" onclick="switchRecipe(event, '${name}', ${i})">R${i+1}</button>`;
            });
            buttons += `</span>`;
        }

        return `<li><span class="${nodeClass}" ${onClickAttr}>${name}</span>${buttons}<ul>${build(p1)}${build(p2)}</ul></li>`;
    }

    let treeHTML = `<div class="genealogy-tree"><ul>${build(target, true)}</ul></div>`;
    let sumHTML = `<div class="summary-section"><b>ã€å¿…è¦ç´ æåˆè¨ˆã€‘</b>\n` + 
                  Object.entries(summary).map(([m, c]) => `${m} Ã— ${c}`).join("\n") + `</div>`;

    output.innerHTML = treeHTML + sumHTML;
}

loadData();
</script>
</body>
</html>
